<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Media - Addarr</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>    
</head>

<body>
    <div class="container-fluid bg-dark py-2">
        <div class="container d-flex align-items-center">
            <a href="/" class="d-flex align-items-center text-decoration-none me-auto">
                <img src="/static/images/logo.png" alt="Addarr Logo" height="40" class="me-2">
                <span class="text-light">Media Manager</span>
            </a>
            <a href="/" class="btn btn-outline-light">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container mt-4">

        <!-- Filter and Search Controls -->
        <div class="row mb-4">
            <div class="col-md-6 mb-2">
                <div class="input-group">
                    <span class="btn btn-primary input-group-text">
                        <i class="fas fa-filter"></i>
                    </span>
                    <select id="mediaFilter" class="form-select">
                        <option value="all">All Media</option>
                        <option value="movie">Movies Only</option>
                        <option value="tv">TV Shows Only</option>
                    </select>
                </div>
            </div>

            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="mediaSearch" class="form-control" placeholder="Search media...">
                    <button class="btn btn-primary" id="searchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Media Grid -->
            <div class="row" id="mediaGrid">
                {% for item in media %}
                    <div class="col-12 mb-3 media-item {% if item.media_type == 'movie' %}movie-item{% else %}tv-item{% endif %}" 
                        data-title="{{ item.title|lower }}" 
                        data-id="{% if item.media_type == 'movie' %}{{ item.tmdbId }}{% else %}{{ item.tvdbId }}{% endif %}" 
                        onclick="showManageDetails('{{ item.media_type }}', {% if item.media_type == 'movie' %}{{ item.tmdbId }}{% else %}{{ item.tvdbId }}{% endif %}, {{ item.id }})">
                        
                        <div class="manage-result-card h-100 d-flex {% if item.media_type == 'movie' %}movie-card{% else %}tv-card{% endif %}">
                             <!-- Watermark Icon -->
                            <div class="watermark-icon position-absolute">
                                {% if item.media_type == 'movie' %}
                                    <i class="fas fa-film"></i>
                                {% else %}
                                    <i class="fas fa-tv"></i>
                                {% endif %}
                            </div>

                            <!-- Thumbnail container - smaller on left -->
                            <div class="manage-result-thumbnail-container me-3" style="width: 100px; flex-shrink: 0;">
                                <img src="{% if item.images %}{% for image in item.images %}{% if image.coverType == 'poster' %}{{ image.remoteUrl }}{% endif %}{% endfor %}{% endif %}{% if not item.images or not item.images|selectattr('coverType', 'equalto', 'poster')|list %}/static/images/favicon.png{% endif %}" 
                                    class="manage-result-thumbnail h-100 w-100 object-fit-cover"
                                    alt="{{ item.title }}"
                                    onerror="this.onerror=null; this.src='/static/images/favicon.png'">
                            </div>
                            
                            <!-- Card content - on right of thumbnail -->
                            <div class="manage-result-content flex-grow-1 d-flex flex-column justify-content-between">
                                <div>
                                    <h5 class="text-white mb-1">
                                        {{ item.title }}
                                    </h5>
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="text-xs me-2">{{ item.year }}</span>
                                        {% if item.certification %}
                                        <span class="badge bg-dark text-white me-2">{{ item.certification }}</span>
                                        {% endif %}
                                        <span class="text-xs">
                                            {% if item.media_type == 'movie' %}
                                                {{ item.runtime }} min
                                            {% else %}
                                                {{ item.statistics.seasonCount }} seasons
                                            {% endif %}
                                        </span>
                                    </div>
                                    <p class="text-xs mb-2 line-clamp-2">{{ item.overview|truncate(120) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
    </div>

    <!-- Modal for confirmation -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Are you sure you want to delete this item?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmAction">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for details -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">Media Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsContent">
                Loading...
                </div>
                <!-- <div class="modal-footer">
                    <button class="btn btn-danger" id="deleteShowBtn">Delete Show</button>
                    <button class="btn btn-warning" id="deleteAllFilesBtn">Delete All Files</button>
                    <button class="btn btn-primary" id="searchAllMissingBtn">Search All Missing</button>
                </div> -->
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-center">
        <div class="spinner-border spinner-radarr" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Filter and search functionality
    function updateMediaDisplay() {
        const searchTerm = document.getElementById('mediaSearch').value.toLowerCase();
        const currentFilter = document.getElementById('mediaFilter').value;
        
        document.querySelectorAll('.media-item').forEach(item => {
            const title = item.dataset.title;
            const isMovie = item.classList.contains('movie-item');
            const isTV = item.classList.contains('tv-item');
            
            const matchesSearch = searchTerm === '' || title.includes(searchTerm);
            const matchesFilter = currentFilter === 'all' || 
                                (currentFilter === 'movie' && isMovie) || 
                                (currentFilter === 'tv' && isTV);
            
            item.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners for filtering and search
        document.getElementById('mediaFilter').addEventListener('change', updateMediaDisplay);
        document.getElementById('mediaSearch').addEventListener('input', updateMediaDisplay);
        document.getElementById('searchButton').addEventListener('click', updateMediaDisplay);
        
        // Initial display update
        updateMediaDisplay();

        // Monitor toggle functionality
        document.querySelectorAll('.monitor-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const type = this.dataset.type;
                const id = this.dataset.id;
                const monitored = this.checked;
                
                fetch(`/api/${type}/${id}/monitor`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ monitored })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update monitoring status');
                    }
                })
                .catch(error => {
                    console.error(error);
                    this.checked = !monitored; // Revert on error
                    alert('Failed to update monitoring status');
                });
            });
        });

        // Search button functionality
        document.querySelectorAll('.search-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering card click
                const type = this.dataset.type;
                const id = this.dataset.id;
                
                fetch(`/api/${type}/${id}/search`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Search initiated successfully');
                    } else {
                        throw new Error('Failed to initiate search');
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert('Failed to initiate search');
                });
            });
        });

        // Delete button functionality
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        let pendingDelete = null;
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering card click
                pendingDelete = {
                    type: this.dataset.type,
                    id: this.dataset.id
                };
                document.getElementById('confirmModalBody').textContent = 
                    `Are you sure you want to delete this ${pendingDelete.type}?`;
                confirmModal.show();
            });
        });

        document.getElementById('confirmAction').addEventListener('click', function() {
            if (pendingDelete) {
                fetch(`/api/${pendingDelete.type}/${pendingDelete.id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        throw new Error('Failed to delete item');
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert('Failed to delete item');
                })
                .finally(() => {
                    confirmModal.hide();
                });
            }
        });
    });
    </script>

    <div id="overlay-backdrop" class="overlay-backdrop"></div>
    <div id="modal-overlay-backdrop" class="overlay-backdrop modal-overlay-backdrop"></div>
    <div class="spinner-border spinner-radarr" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>  
    
    
    <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/static/sw.js')
            .then(registration => {
                console.log('ServiceWorker registration successful');
            })
            .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    </script>    
</body>
</html>